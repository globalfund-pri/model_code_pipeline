
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../tutorial/">
      
      
        <link rel="next" href="../getting_started/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.2">
    
    
      
        <title>Reference - tgftools Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.50c56a3b.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#reference-book" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="tgftools Documentation" class="md-header__button md-logo" aria-label="tgftools Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            tgftools Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Reference
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="tgftools Documentation" class="md-nav__button md-logo" aria-label="tgftools Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    tgftools Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tutorial
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Reference
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Reference
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.database" class="md-nav__link">
    <span class="md-ellipsis">
      database
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.database.Database" class="md-nav__link">
    <span class="md-ellipsis">
      Database
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Database">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.tgftools.database.Database.get_country" class="md-nav__link">
    <span class="md-ellipsis">
      get_country()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.checks" class="md-nav__link">
    <span class="md-ellipsis">
      checks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.checks.CheckReport" class="md-nav__link">
    <span class="md-ellipsis">
      CheckReport
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.checks.CheckResult" class="md-nav__link">
    <span class="md-ellipsis">
      CheckResult
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.checks.ConsolidatedChecksReport" class="md-nav__link">
    <span class="md-ellipsis">
      ConsolidatedChecksReport
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ConsolidatedChecksReport">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.tgftools.checks.ConsolidatedChecksReport.add_check_report" class="md-nav__link">
    <span class="md-ellipsis">
      add_check_report()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.checks.ConsolidatedChecksReport.report" class="md-nav__link">
    <span class="md-ellipsis">
      report()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.checks.DatabaseChecks" class="md-nav__link">
    <span class="md-ellipsis">
      DatabaseChecks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DatabaseChecks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.tgftools.checks.DatabaseChecks.run" class="md-nav__link">
    <span class="md-ellipsis">
      run()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.checks.critical" class="md-nav__link">
    <span class="md-ellipsis">
      critical()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.checks.is_critical" class="md-nav__link">
    <span class="md-ellipsis">
      is_critical()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.analysis" class="md-nav__link">
    <span class="md-ellipsis">
      analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.dump_everything_to_xlsx" class="md-nav__link">
    <span class="md-ellipsis">
      dump_everything_to_xlsx()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.filter_funding_data_for_non_modelled_countries" class="md-nav__link">
    <span class="md-ellipsis">
      filter_funding_data_for_non_modelled_countries()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.get_counterfactual_infections_averted_malaria" class="md-nav__link">
    <span class="md-ellipsis">
      get_counterfactual_infections_averted_malaria()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.get_counterfactual_lives_saved_malaria" class="md-nav__link">
    <span class="md-ellipsis">
      get_counterfactual_lives_saved_malaria()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.get_data_frames_for_approach_b" class="md-nav__link">
    <span class="md-ellipsis">
      get_data_frames_for_approach_b()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.get_gp" class="md-nav__link">
    <span class="md-ellipsis">
      get_gp()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.get_partner" class="md-nav__link">
    <span class="md-ellipsis">
      get_partner()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.make_diagnostic_report" class="md-nav__link">
    <span class="md-ellipsis">
      make_diagnostic_report()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.portfolio_projection_approach_a" class="md-nav__link">
    <span class="md-ellipsis">
      portfolio_projection_approach_a()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.portfolio_projection_approach_b" class="md-nav__link">
    <span class="md-ellipsis">
      portfolio_projection_approach_b()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.portfolio_projection_approach_c" class="md-nav__link">
    <span class="md-ellipsis">
      portfolio_projection_approach_c()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.portfolio_projection_counterfactual" class="md-nav__link">
    <span class="md-ellipsis">
      portfolio_projection_counterfactual()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.analysis.CountryProjection" class="md-nav__link">
    <span class="md-ellipsis">
      CountryProjection
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.analysis.PortfolioProjection" class="md-nav__link">
    <span class="md-ellipsis">
      PortfolioProjection
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.report" class="md-nav__link">
    <span class="md-ellipsis">
      report
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.report.Report" class="md-nav__link">
    <span class="md-ellipsis">
      Report
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Report">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.tgftools.report.Report.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.report.Report.report" class="md-nav__link">
    <span class="md-ellipsis">
      report()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting_started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ic7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Investment Case 7
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ic8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Investment Case 8
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.database" class="md-nav__link">
    <span class="md-ellipsis">
      database
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.database.Database" class="md-nav__link">
    <span class="md-ellipsis">
      Database
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Database">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.tgftools.database.Database.get_country" class="md-nav__link">
    <span class="md-ellipsis">
      get_country()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.checks" class="md-nav__link">
    <span class="md-ellipsis">
      checks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.checks.CheckReport" class="md-nav__link">
    <span class="md-ellipsis">
      CheckReport
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.checks.CheckResult" class="md-nav__link">
    <span class="md-ellipsis">
      CheckResult
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.checks.ConsolidatedChecksReport" class="md-nav__link">
    <span class="md-ellipsis">
      ConsolidatedChecksReport
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ConsolidatedChecksReport">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.tgftools.checks.ConsolidatedChecksReport.add_check_report" class="md-nav__link">
    <span class="md-ellipsis">
      add_check_report()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.checks.ConsolidatedChecksReport.report" class="md-nav__link">
    <span class="md-ellipsis">
      report()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.checks.DatabaseChecks" class="md-nav__link">
    <span class="md-ellipsis">
      DatabaseChecks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DatabaseChecks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.tgftools.checks.DatabaseChecks.run" class="md-nav__link">
    <span class="md-ellipsis">
      run()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.checks.critical" class="md-nav__link">
    <span class="md-ellipsis">
      critical()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.checks.is_critical" class="md-nav__link">
    <span class="md-ellipsis">
      is_critical()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.analysis" class="md-nav__link">
    <span class="md-ellipsis">
      analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.dump_everything_to_xlsx" class="md-nav__link">
    <span class="md-ellipsis">
      dump_everything_to_xlsx()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.filter_funding_data_for_non_modelled_countries" class="md-nav__link">
    <span class="md-ellipsis">
      filter_funding_data_for_non_modelled_countries()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.get_counterfactual_infections_averted_malaria" class="md-nav__link">
    <span class="md-ellipsis">
      get_counterfactual_infections_averted_malaria()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.get_counterfactual_lives_saved_malaria" class="md-nav__link">
    <span class="md-ellipsis">
      get_counterfactual_lives_saved_malaria()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.get_data_frames_for_approach_b" class="md-nav__link">
    <span class="md-ellipsis">
      get_data_frames_for_approach_b()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.get_gp" class="md-nav__link">
    <span class="md-ellipsis">
      get_gp()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.get_partner" class="md-nav__link">
    <span class="md-ellipsis">
      get_partner()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.make_diagnostic_report" class="md-nav__link">
    <span class="md-ellipsis">
      make_diagnostic_report()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.portfolio_projection_approach_a" class="md-nav__link">
    <span class="md-ellipsis">
      portfolio_projection_approach_a()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.portfolio_projection_approach_b" class="md-nav__link">
    <span class="md-ellipsis">
      portfolio_projection_approach_b()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.portfolio_projection_approach_c" class="md-nav__link">
    <span class="md-ellipsis">
      portfolio_projection_approach_c()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.analysis.Analysis.portfolio_projection_counterfactual" class="md-nav__link">
    <span class="md-ellipsis">
      portfolio_projection_counterfactual()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.analysis.CountryProjection" class="md-nav__link">
    <span class="md-ellipsis">
      CountryProjection
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.analysis.PortfolioProjection" class="md-nav__link">
    <span class="md-ellipsis">
      PortfolioProjection
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.report" class="md-nav__link">
    <span class="md-ellipsis">
      report
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.tgftools.report.Report" class="md-nav__link">
    <span class="md-ellipsis">
      Report
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Report">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.tgftools.report.Report.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.tgftools.report.Report.report" class="md-nav__link">
    <span class="md-ellipsis">
      report()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="reference-book">Reference Book</h1>


<div class="doc doc-object doc-module">



<a id="src.tgftools.database"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">




<h2 id="src.tgftools.database.Database" class="doc doc-heading">
          <code>Database</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>This is the Database class. It holds all data related to a single disease. It also holds an emulator which
can be used to create results for scenarios that are not stored.</p>

            <details class="quote">
              <summary>Source code in <code>src/tgftools/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Database</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is the Database class. It holds all data related to a single disease. It also holds an emulator which</span>
<span class="sd">    can be used to create results for scenarios that are not stored.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">gp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Gp</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">partner_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PartnerData</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pf_input_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PFInputData</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_results</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ModelResults</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gp</span> <span class="o">=</span> <span class="n">gp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partner_data</span> <span class="o">=</span> <span class="n">partner_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pf_input_data</span> <span class="o">=</span> <span class="n">pf_input_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_results</span> <span class="o">=</span> <span class="n">model_results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span> <span class="o">=</span> <span class="n">model_results</span><span class="o">.</span><span class="n">disease_name</span>

        <span class="c1"># Check that all these filehandlers have the same disease_name (if they are defined)</span>
        <span class="n">disease_name_where_args_defined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">disease_name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">partner_data</span><span class="p">,</span> <span class="n">pf_input_data</span><span class="p">,</span> <span class="n">model_results</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">disease_name_where_args_defined</span> <span class="o">==</span> <span class="n">disease_name_where_args_defined</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_country</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">country</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">scenario_descriptor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">funding_fraction</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">indicator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Data for a particular country, scenario_descriptor, funding_fraction and indicator.</span>

<span class="sd">        Args:</span>
<span class="sd">            country: The country (ISO3 code)</span>
<span class="sd">            scenario_descriptor: The scenario descriptor (e.g. &#39;default&#39;)</span>
<span class="sd">            funding_fraction: The funding fraction (e.g. 0.9)</span>
<span class="sd">            indicator: The indicator (e.g.&#39;cases&#39;)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dataframe that assembles the information from all sources for a particular country, for a particular</span>
<span class="sd">             scenario, funding_fraction and indicator (If the indicator is not found within the</span>
<span class="sd">             pf_input_date or partner_data, then NaN&#39;s are used instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="n">funding_fraction</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">indicator</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;model_&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_pf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pf_input_data</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">indicator</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;pf_&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">_pf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">index</span><span class="o">=</span><span class="n">_model</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pf_&quot;</span> <span class="o">+</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;central&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)],</span>
                <span class="n">data</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_partner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partner_data</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">indicator</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;partner_&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">_partner</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">index</span><span class="o">=</span><span class="n">_model</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;partner_&quot;</span> <span class="o">+</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;central&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)],</span>
                <span class="n">data</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">_model</span><span class="p">,</span> <span class="n">_pf</span><span class="p">,</span> <span class="n">_partner</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h3 id="src.tgftools.database.Database.get_country" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_country</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="n">scenario_descriptor</span><span class="p">,</span> <span class="n">funding_fraction</span><span class="p">,</span> <span class="n">indicator</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Data for a particular country, scenario_descriptor, funding_fraction and indicator.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>country</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The country (ISO3 code)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>scenario_descriptor</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The scenario descriptor (e.g. 'default')</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>funding_fraction</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The funding fraction (e.g. 0.9)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>indicator</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The indicator (e.g.'cases')</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dataframe that assembles the information from all sources for a particular country, for a particular
scenario, funding_fraction and indicator (If the indicator is not found within the
pf_input_date or partner_data, then NaN's are used instead.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/database.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_country</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">country</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">scenario_descriptor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">funding_fraction</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">indicator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Data for a particular country, scenario_descriptor, funding_fraction and indicator.</span>

<span class="sd">    Args:</span>
<span class="sd">        country: The country (ISO3 code)</span>
<span class="sd">        scenario_descriptor: The scenario descriptor (e.g. &#39;default&#39;)</span>
<span class="sd">        funding_fraction: The funding fraction (e.g. 0.9)</span>
<span class="sd">        indicator: The indicator (e.g.&#39;cases&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dataframe that assembles the information from all sources for a particular country, for a particular</span>
<span class="sd">         scenario, funding_fraction and indicator (If the indicator is not found within the</span>
<span class="sd">         pf_input_date or partner_data, then NaN&#39;s are used instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="n">funding_fraction</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">indicator</span><span class="p">)</span>
    <span class="p">]</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;model_&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">_pf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pf_input_data</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">indicator</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;pf_&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">_pf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="n">_model</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pf_&quot;</span> <span class="o">+</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;central&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)],</span>
            <span class="n">data</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">_partner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partner_data</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">indicator</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;partner_&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">_partner</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="n">_model</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;partner_&quot;</span> <span class="o">+</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;central&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)],</span>
            <span class="n">data</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">_model</span><span class="p">,</span> <span class="n">_pf</span><span class="p">,</span> <span class="n">_partner</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<a id="src.tgftools.checks"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">




<h2 id="src.tgftools.checks.CheckReport" class="doc doc-heading">
          <code>CheckReport</code>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">

  
      <p>DataClass for report to be saved from having run a single check</p>

            <details class="quote">
              <summary>Source code in <code>src/tgftools/checks.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">CheckReport</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;DataClass for report to be saved from having run a single check&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">is_critical</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">passes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">message</span><span class="p">:</span> <span class="p">[</span>
        <span class="nb">str</span><span class="p">,</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span>
        <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="nb">list</span><span class="p">[</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">],</span>
    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h2 id="src.tgftools.checks.CheckResult" class="doc doc-heading">
          <code>CheckResult</code>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">

  
      <p>DataClass for result of a single check</p>

            <details class="quote">
              <summary>Source code in <code>src/tgftools/checks.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">CheckResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;DataClass for result of a single check&quot;&quot;&quot;</span>

    <span class="n">passes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">message</span><span class="p">:</span> <span class="p">[</span>
        <span class="nb">str</span><span class="p">,</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span>
        <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="nb">list</span><span class="p">[</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">],</span>
    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h2 id="src.tgftools.checks.ConsolidatedChecksReport" class="doc doc-heading">
          <code>ConsolidatedChecksReport</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>This class is used to capture the reports from individual checks and compile them into a consolidated report,
which is printed to the console and written to a pdf.</p>

            <details class="quote">
              <summary>Source code in <code>src/tgftools/checks.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ConsolidatedChecksReport</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class is used to capture the reports from individual checks and compile them into a consolidated report,</span>
<span class="sd">    which is printed to the console and written to a pdf.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">doc</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filenames</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_doc</span> <span class="o">=</span> <span class="n">doc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filenames</span> <span class="o">=</span> <span class="n">filenames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_reports</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="c1"># Create empty list for the &quot;flowables&quot; for the pdf generation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flowables</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Load components for pdf generation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">styles</span> <span class="o">=</span> <span class="n">getSampleStyleSheet</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacer</span> <span class="o">=</span> <span class="n">Spacer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">inch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">small_spacer</span> <span class="o">=</span> <span class="n">Spacer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">inch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">horizontal_line</span> <span class="o">=</span> <span class="n">HRFlowable</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_check_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch_rep</span><span class="p">:</span> <span class="n">CheckReport</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the result of a check&quot;&quot;&quot;</span>

        <span class="c1"># if the message is an empty list, replace it with it None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch_rep</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch_rep</span><span class="o">.</span><span class="n">message</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ch_rep</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Check that the message is of the right type (or none)</span>
        <span class="k">if</span> <span class="n">ch_rep</span><span class="o">.</span><span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">item_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
            <span class="n">single_element</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ch_rep</span><span class="o">.</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch_rep</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">ch_rep</span><span class="o">.</span><span class="n">message</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">single_element</span><span class="p">,</span> <span class="n">item_types</span><span class="p">),</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Message is of the wrong type </span><span class="si">{</span><span class="n">ch_rep</span><span class="o">.</span><span class="n">message</span><span class="si">=}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">single_element</span><span class="si">=}</span><span class="s2">, type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">single_element</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Add to internal storage list of CheckReports</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_reports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch_rep</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">passing_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">rep</span> <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_reports</span> <span class="k">if</span> <span class="n">rep</span><span class="o">.</span><span class="n">passes</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">non_critical_failing_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">rep</span> <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_reports</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">rep</span><span class="o">.</span><span class="n">passes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rep</span><span class="o">.</span><span class="n">is_critical</span>
        <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">critical_failing_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">rep</span> <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_reports</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">rep</span><span class="o">.</span><span class="n">passes</span> <span class="ow">and</span> <span class="n">rep</span><span class="o">.</span><span class="n">is_critical</span>
        <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">any_fails</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">critical_failing_checks</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">non_critical_failing_checks</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">echo_to_console</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print to console and add into a &#39;flowables&#39; list for pdf generation.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">style</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">styles</span><span class="p">[</span><span class="s2">&quot;Normal&quot;</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">handle_item</span><span class="p">(</span><span class="n">this_item</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">this_item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">this_item</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                    <span class="c1"># Handle blank line command</span>
                    <span class="k">if</span> <span class="n">echo_to_console</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">flowables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spacer</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">this_item</span> <span class="o">==</span> <span class="s2">&quot;---&quot;</span><span class="p">:</span>
                    <span class="c1"># Insert horizontal line</span>
                    <span class="k">if</span> <span class="n">echo_to_console</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------------------------------&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">flowables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizontal_line</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">this_item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ICON=&quot;</span><span class="p">):</span>
                    <span class="c1"># Insert icon indicated</span>
                    <span class="n">icon_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
                        <span class="n">get_root_path</span><span class="p">()</span>
                        <span class="o">/</span> <span class="s2">&quot;resources&quot;</span>
                        <span class="o">/</span> <span class="s2">&quot;icons&quot;</span>
                        <span class="o">/</span> <span class="n">this_item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;ICON=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">flowables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">icon_file</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Handle simple string</span>
                    <span class="k">if</span> <span class="n">this_item</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">echo_to_console</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">this_item</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">flowables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Paragraph</span><span class="p">(</span><span class="n">deEmojify</span><span class="p">(</span><span class="n">this_item</span><span class="p">),</span> <span class="n">style</span><span class="p">))</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">this_item</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">echo_to_console</span><span class="p">:</span>
                    <span class="n">this_item</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flowables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig2image</span><span class="p">(</span><span class="n">this_item</span><span class="p">))</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">this_item</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">echo_to_console</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">this_item</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flowables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df2table</span><span class="p">(</span><span class="n">this_item</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># item type not recognised: ignore</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If the item is None, then do nothing</span>
            <span class="k">return</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># If the item is actually a list of items, handle each item in turn</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">handle_item</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flowables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">small_spacer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If the item is a single item, just handle it.</span>
            <span class="n">handle_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the content of a report (for console and pdf).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flowables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flowables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">Image</span><span class="p">(</span><span class="n">get_root_path</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;resources/icons/logo.jpg&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_title</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">styles</span><span class="p">[</span><span class="s2">&quot;Heading1&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_doc</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">styles</span><span class="p">[</span><span class="s2">&quot;Normal&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">current_date_and_time_as_string</span><span class="p">(),</span> <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">styles</span><span class="p">[</span><span class="s2">&quot;Heading3&quot;</span><span class="p">])</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Files Used:&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">styles</span><span class="p">[</span><span class="s2">&quot;Heading3&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filenames</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;* </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">styles</span><span class="p">[</span><span class="s2">&quot;Normal&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Git Commit: </span><span class="si">{</span><span class="n">get_commit_revision_number</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>

        <span class="c1"># Determine summary outcome of the set of checks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">critical_failing_checks</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span>
                <span class="s2">&quot;❌Some checks have failed, including some that are CRITICAL.&quot;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">styles</span><span class="p">[</span><span class="s2">&quot;Heading2&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s2">&quot;ICON=cross.jpg&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_critical_failing_checks</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span>
                <span class="s2">&quot;🤷Some checks have failed, but none are CRITICAL.&quot;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">styles</span><span class="p">[</span><span class="s2">&quot;Heading2&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s2">&quot;ICON=shrug.jpg&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s2">&quot;✅All checks passed.&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">styles</span><span class="p">[</span><span class="s2">&quot;Heading2&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s2">&quot;ICON=tick.jpg&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>

        <span class="c1"># Print details of each check to the console</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">critical_failing_checks</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s2">&quot;🚨CRITICAL FAILING CHECKS&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">styles</span><span class="p">[</span><span class="s2">&quot;Heading2&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">critical_failing_checks</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    👎FAILED: </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">styles</span><span class="p">[</span><span class="s2">&quot;Heading3&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">styles</span><span class="p">[</span><span class="s2">&quot;Normal&quot;</span><span class="p">],</span> <span class="n">echo_to_console</span><span class="o">=</span><span class="n">verbose</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">echo_to_console</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_critical_failing_checks</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s2">&quot;🤔 NON-CRITICAL FAILING CHECKS&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">styles</span><span class="p">[</span><span class="s2">&quot;Heading2&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_critical_failing_checks</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    👎FAILED: </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">styles</span><span class="p">[</span><span class="s2">&quot;Heading3&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">styles</span><span class="p">[</span><span class="s2">&quot;Normal&quot;</span><span class="p">],</span> <span class="n">echo_to_console</span><span class="o">=</span><span class="n">verbose</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">echo_to_console</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">passing_checks</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s2">&quot;❤️ PASSING CHECKS&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">styles</span><span class="p">[</span><span class="s2">&quot;Heading2&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">passing_checks</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    👍PASSED: </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">styles</span><span class="p">[</span><span class="s2">&quot;Heading3&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">styles</span><span class="p">[</span><span class="s2">&quot;Normal&quot;</span><span class="p">],</span> <span class="n">echo_to_console</span><span class="o">=</span><span class="n">verbose</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">echo_to_console</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print a consolidated report the console. If `verbose=True` then details of all the failures are provided.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_report</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing to pdf at: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: ....&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">SimpleDocTemplate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">pageSize</span><span class="o">=</span><span class="n">reportlab</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">pagesizes</span><span class="o">.</span><span class="n">A4</span><span class="p">)</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flowables</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h3 id="src.tgftools.checks.ConsolidatedChecksReport.add_check_report" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">add_check_report</span><span class="p">(</span><span class="n">ch_rep</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Add the result of a check</p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/checks.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_check_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch_rep</span><span class="p">:</span> <span class="n">CheckReport</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add the result of a check&quot;&quot;&quot;</span>

    <span class="c1"># if the message is an empty list, replace it with it None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch_rep</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch_rep</span><span class="o">.</span><span class="n">message</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ch_rep</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Check that the message is of the right type (or none)</span>
    <span class="k">if</span> <span class="n">ch_rep</span><span class="o">.</span><span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">item_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
        <span class="n">single_element</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ch_rep</span><span class="o">.</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch_rep</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">ch_rep</span><span class="o">.</span><span class="n">message</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">single_element</span><span class="p">,</span> <span class="n">item_types</span><span class="p">),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Message is of the wrong type </span><span class="si">{</span><span class="n">ch_rep</span><span class="o">.</span><span class="n">message</span><span class="si">=}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">single_element</span><span class="si">=}</span><span class="s2">, type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">single_element</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Add to internal storage list of CheckReports</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_check_reports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch_rep</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="src.tgftools.checks.ConsolidatedChecksReport.report" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">report</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Print a consolidated report the console. If <code>verbose=True</code> then details of all the failures are provided.</p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/checks.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print a consolidated report the console. If `verbose=True` then details of all the failures are provided.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_generate_report</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing to pdf at: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: ....&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">SimpleDocTemplate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">pageSize</span><span class="o">=</span><span class="n">reportlab</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">pagesizes</span><span class="o">.</span><span class="n">A4</span><span class="p">)</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flowables</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h2 id="src.tgftools.checks.DatabaseChecks" class="doc doc-heading">
          <code>DatabaseChecks</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>This is the base class for the DatabaseChecks.
The functions defined in the base class do the "behind the scenes" things needed to make the inherited class work.</p>
<p>Each function defined in the inheriting class is a check to be performed on the Database. The name of the function
 should be informative and the docstring should explain exactly what is being tested. In the check, <code>assert</code> is
 used to indicate what must be True for the check to pass; and an error message is provided giving information
 if it does not. The <code>@critical</code> decorator is used to label certain of the checks as being 'critical'. A different
 overall message is given according to whether there are any failure of 'critical' checks or only failures of
 'non-critical' checks.</p>

            <details class="quote">
              <summary>Source code in <code>src/tgftools/checks.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">DatabaseChecks</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is the base class for the DatabaseChecks.</span>
<span class="sd">    The functions defined in the base class do the &quot;behind the scenes&quot; things needed to make the inherited class work.</span>

<span class="sd">    Each function defined in the inheriting class is a check to be performed on the Database. The name of the function</span>
<span class="sd">     should be informative and the docstring should explain exactly what is being tested. In the check, `assert` is</span>
<span class="sd">     used to indicate what must be True for the check to pass; and an error message is provided giving information</span>
<span class="sd">     if it does not. The `@critical` decorator is used to label certain of the checks as being &#39;critical&#39;. A different</span>
<span class="sd">     overall message is given according to whether there are any failure of &#39;critical&#39; checks or only failures of</span>
<span class="sd">     &#39;non-critical&#39; checks.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Parameters</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccr</span> <span class="o">=</span> <span class="n">ConsolidatedChecksReport</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="n">filenames</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;Model Results&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                <span class="s2">&quot;Partner Data&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">partner_data</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">partner_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;PF Input Data&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">pf_input_data</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">pf_input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">the_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CheckReport</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run a particular check and return a Check Result.</span>
<span class="sd">        * A `CheckResult` instance should be returned by each check, giving the result of the check and a message</span>
<span class="sd">        * If nothing is returned, the check is assumed to have passed.</span>
<span class="sd">        * If an AssertionError occurs in the test, then it is assumed the check has failed and the message in the error</span>
<span class="sd">          is used as the message in the check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Capture the static information about the check.</span>
        <span class="n">header</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">the_func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">the_func</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">,</span>
            <span class="n">is_critical</span><span class="o">=</span><span class="n">is_critical</span><span class="p">(</span><span class="n">the_func</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ch_res</span><span class="p">:</span> <span class="n">CheckResult</span> <span class="o">=</span> <span class="n">the_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ch_res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">CheckReport</span><span class="p">(</span><span class="o">**</span><span class="n">header</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch_res</span><span class="p">,</span> <span class="n">CheckResult</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">CheckReport</span><span class="p">(</span>
                    <span class="o">**</span><span class="n">header</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="n">ch_res</span><span class="o">.</span><span class="n">passes</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">ch_res</span><span class="o">.</span><span class="n">message</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Check </span><span class="si">{</span><span class="n">the_func</span><span class="si">}</span><span class="s2"> returned unexpected item&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">assertion_error</span><span class="p">:</span>
            <span class="n">message_in_assertion_error</span> <span class="o">=</span> <span class="n">assertion_error</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">CheckReport</span><span class="p">(</span>
                <span class="o">**</span><span class="n">header</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message_in_assertion_error</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">suppress_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run all the checks that are defined in this class and returns True if all checks pass.</span>
<span class="sd">        A summary of the checks is printed to console. By default, any failed checks lead to an Error, but this can be</span>
<span class="sd">         stopped with `suppress_error`. Optionally, the results of the checks can be saved to a logfile.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Run all the checks</span>
        <span class="n">wipe</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✨ Initiating checks </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="si">}</span><span class="s2"> ✨&quot;</span><span class="p">)</span>
        <span class="n">check_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_check_names</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ch_name</span> <span class="ow">in</span> <span class="n">check_names</span><span class="p">:</span>
            <span class="n">ch_func</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">ch_name</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="n">ch_name</span><span class="si">}</span><span class="s2"> .....&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ccr</span><span class="o">.</span><span class="n">add_check_report</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_check</span><span class="p">(</span><span class="n">ch_func</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>

        <span class="c1"># Report (print to console and, optionally, create pdf)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccr</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># Determine if error should be thrown</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccr</span><span class="o">.</span><span class="n">any_fails</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">suppress_error</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DataCheckError</span><span class="p">(</span><span class="s2">&quot;Some checks have failed.&quot;</span><span class="p">)</span>

        <span class="c1"># Determine the outcome bool (True if there have been no fails)</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccr</span><span class="o">.</span><span class="n">any_fails</span>

    <span class="k">def</span> <span class="nf">_get_check_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the names of the checks found in the class.</span>
<span class="sd">        (A check is any function defined in the class where the name is not `run` or begins with `_`.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">name</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;XX&quot;</span><span class="p">))</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;run_&quot;</span><span class="p">))</span>
                        <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;run&quot;</span><span class="p">}</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h3 id="src.tgftools.checks.DatabaseChecks.run" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">run</span><span class="p">(</span><span class="n">suppress_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Run all the checks that are defined in this class and returns True if all checks pass.
A summary of the checks is printed to console. By default, any failed checks lead to an Error, but this can be
 stopped with <code>suppress_error</code>. Optionally, the results of the checks can be saved to a logfile.</p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/checks.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">suppress_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run all the checks that are defined in this class and returns True if all checks pass.</span>
<span class="sd">    A summary of the checks is printed to console. By default, any failed checks lead to an Error, but this can be</span>
<span class="sd">     stopped with `suppress_error`. Optionally, the results of the checks can be saved to a logfile.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Run all the checks</span>
    <span class="n">wipe</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✨ Initiating checks </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="si">}</span><span class="s2"> ✨&quot;</span><span class="p">)</span>
    <span class="n">check_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_check_names</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ch_name</span> <span class="ow">in</span> <span class="n">check_names</span><span class="p">:</span>
        <span class="n">ch_func</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">ch_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="n">ch_name</span><span class="si">}</span><span class="s2"> .....&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccr</span><span class="o">.</span><span class="n">add_check_report</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_check</span><span class="p">(</span><span class="n">ch_func</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>

    <span class="c1"># Report (print to console and, optionally, create pdf)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ccr</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="c1"># Determine if error should be thrown</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccr</span><span class="o">.</span><span class="n">any_fails</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">suppress_error</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DataCheckError</span><span class="p">(</span><span class="s2">&quot;Some checks have failed.&quot;</span><span class="p">)</span>

    <span class="c1"># Determine the outcome bool (True if there have been no fails)</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccr</span><span class="o">.</span><span class="n">any_fails</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>



<div class="doc doc-object doc-function">




<h2 id="src.tgftools.checks.critical" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">critical</span><span class="p">(</span><span class="n">func</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Decorator used to signify that a particular check is a 'critical'.</p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/checks.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">critical</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator used to signify that a particular check is a &#39;critical&#39;.&quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">wrapped</span><span class="o">.</span><span class="n">critical</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">wrapped</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="src.tgftools.checks.is_critical" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">is_critical</span><span class="p">(</span><span class="n">func</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns True if the function has been decorated as <code>@critical</code>.
From: https://stackoverflow.com/a/68583930</p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/checks.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_critical</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns True if the function has been decorated as `@critical`.</span>
<span class="sd">    From: https://stackoverflow.com/a/68583930&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;critical&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<a id="src.tgftools.analysis"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">




<h2 id="src.tgftools.analysis.Analysis" class="doc doc-heading">
          <code>Analysis</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>This is the Analysis class. It holds a Database object and requires an argument for the scenario_descriptor.
It can then output ensemble results (or country-level results) that reflect decisions for the use of the funding -
in particular, when the TGF funding is non-fungible (Approach A) and when it is fungible and its allocation
between countries can be optimised (Approach B).
:param years_for_funding: Defines the calendar years (integers) for which the budgets correspond, (i.e, the years
 to which the replenishment funding scenarios correspond).
:param handle_out_of_bounds_costs: Determines whether an error is thrown when a result for country is needed
 for a cost that is not in the range of the model_results, or whether results are used for highest/lowest cost
 model_results instead. This is passed through to the <code>Emulator</code> class.</p>

            <details class="quote">
              <summary>Source code in <code>src/tgftools/analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is the Analysis class. It holds a Database object and requires an argument for the scenario_descriptor.</span>
<span class="sd">    It can then output ensemble results (or country-level results) that reflect decisions for the use of the funding -</span>
<span class="sd">    in particular, when the TGF funding is non-fungible (Approach A) and when it is fungible and its allocation</span>
<span class="sd">    between countries can be optimised (Approach B).</span>
<span class="sd">    :param years_for_funding: Defines the calendar years (integers) for which the budgets correspond, (i.e, the years</span>
<span class="sd">     to which the replenishment funding scenarios correspond).</span>
<span class="sd">    :param handle_out_of_bounds_costs: Determines whether an error is thrown when a result for country is needed</span>
<span class="sd">     for a cost that is not in the range of the model_results, or whether results are used for highest/lowest cost</span>
<span class="sd">     model_results instead. This is passed through to the `Emulator` class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">database</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span>
        <span class="n">tgf_funding</span><span class="p">:</span> <span class="n">TgfFunding</span><span class="p">,</span>
        <span class="n">non_tgf_funding</span><span class="p">:</span> <span class="n">NonTgfFunding</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Parameters</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Save arguments (nb, funding data are updated again later in __init__)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tgf_funding</span> <span class="o">=</span> <span class="n">tgf_funding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_tgf_funding</span> <span class="o">=</span> <span class="n">non_tgf_funding</span>

        <span class="c1"># Save short-cuts to elements of the database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gp</span><span class="p">:</span> <span class="n">Gp</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">gp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">countries</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">countries</span>

        <span class="c1"># Store some parameters for easy access</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">disease_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get_indicators_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SCENARIO_DESCRIPTOR_FOR_IC&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle_out_of_bounds_costs</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HANDLE_OUT_OF_BOUNDS_COSTS&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">innovation_on</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;INNOVATION_ON&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">years_for_funding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;YEARS_FOR_FUNDING&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicators_for_adj_for_innovations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;INDICATORS_FOR_ADJ_FOR_INNOVATIONS&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_GP_SCENARIO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get_gpscenario</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

        <span class="c1"># Filter funding assumptions for countries that are not modelled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tgf_funding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_funding_data_for_non_modelled_countries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tgf_funding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_tgf_funding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_funding_data_for_non_modelled_countries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_tgf_funding</span><span class="p">)</span>

        <span class="c1"># If we should remove the dominated points, edit the model results accordingly:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;REMOVE_DOMINATED_POINTS&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span> <span class="o">=</span> <span class="n">filter_for_frontier</span><span class="p">(</span>
                <span class="n">model_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="p">,</span>
                <span class="n">scenario_descriptor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span>
                <span class="n">years_for_obj_func</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;YEARS_FOR_OBJ_FUNC&quot;</span><span class="p">),</span>
                <span class="n">years_for_funding</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;YEARS_FOR_FUNDING&quot;</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Create emulators for each country so that results can be created for any cost (within the range of actual</span>
        <span class="c1"># results).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emulators</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">c</span><span class="p">:</span> <span class="n">Emulator</span><span class="p">(</span>
                <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
                <span class="n">scenario_descriptor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span>
                <span class="n">country</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                <span class="n">years_for_funding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">years_for_funding</span><span class="p">,</span>
                <span class="n">handle_out_of_bounds_costs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_out_of_bounds_costs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">countries</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">filter_funding_data_for_non_modelled_countries</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">funding_data_object</span><span class="p">:</span> <span class="n">TgfFunding</span> <span class="o">|</span> <span class="n">NonTgfFunding</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TgfFunding</span> <span class="o">|</span> <span class="n">NonTgfFunding</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a funding data object that has been filtered for countries that are not declared as the modelled</span>
<span class="sd">        countries for that disease.&quot;&quot;&quot;</span>
        <span class="n">list_of_modelled_countries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get_modelled_countries_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span><span class="p">)</span>
        <span class="n">funding_data_object</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">funding_data_object</span><span class="p">)</span>
        <span class="n">funding_data_object</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">funding_data_object</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">funding_data_object</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_of_modelled_countries</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">funding_data_object</span>

    <span class="k">def</span> <span class="nf">portfolio_projection_approach_a</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PortfolioProjection</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the PortfolioProjection For Approach A: i.e., the projection for each country, given the funding</span>
<span class="sd">        to each country when the TGF funding allocated to a country CANNOT be changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">country_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_country_projections_given_funding_dollar_amounts</span><span class="p">(</span>
            <span class="n">total_funding_by_country</span><span class="o">=</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tgf_funding</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_tgf_funding</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">PortfolioProjection</span><span class="p">(</span>
            <span class="n">tgf_funding_by_country</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tgf_funding</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="n">non_tgf_funding_by_country</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">non_tgf_funding</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="n">country_results</span><span class="o">=</span><span class="n">country_results</span><span class="p">,</span>
            <span class="n">portfolio_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_portfolio_results</span><span class="p">(</span>
                <span class="n">country_results</span><span class="o">=</span><span class="n">country_results</span><span class="p">,</span>
                <span class="n">adjust_for_unmodelled_innovation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">innovation_on</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">portfolio_projection_approach_b</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PortfolioProjection</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the PortfolioProjection For Approach B: i.e., the projection for each country, given the funding</span>
<span class="sd">        to each country when the TGF funding allocated to a country _CAN_ be changed. Multiple methods for optimisation</span>
<span class="sd">        may be tried, but only a single result is provided (that of the best solution found.)</span>
<span class="sd">        :param methods: List of methods to use in approach_b (For method see `do_approach_b`)</span>
<span class="sd">        :param optimisation_params: Dict of parameters specifying how to construct the optimisation.</span>
<span class="sd">        See `_get_data_frames_for_approach_b`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use the `ApproachB` class to get the TGF funding allocations from the optimisation, getting only the best</span>
        <span class="c1"># result.</span>

        <span class="n">methods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;APPROACH_B_METHODS&#39;</span><span class="p">)</span>

        <span class="n">results_from_approach_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_approach_b</span><span class="p">()</span><span class="o">.</span><span class="n">do_approach_b</span><span class="p">(</span>
            <span class="n">methods</span><span class="o">=</span><span class="n">methods</span><span class="p">,</span> <span class="n">provide_best_only</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">tgf_funding_under_approach_b</span> <span class="o">=</span> <span class="n">results_from_approach_b</span><span class="o">.</span><span class="n">tgf_budget_by_country</span>

        <span class="n">country_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_country_projections_given_funding_dollar_amounts</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">tgf_funding_under_approach_b</span><span class="p">)</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_tgf_funding</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">PortfolioProjection</span><span class="p">(</span>
            <span class="n">tgf_funding_by_country</span><span class="o">=</span><span class="n">tgf_funding_under_approach_b</span><span class="p">,</span>
            <span class="n">non_tgf_funding_by_country</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">non_tgf_funding</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="n">country_results</span><span class="o">=</span><span class="n">country_results</span><span class="p">,</span>
            <span class="n">portfolio_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_portfolio_results</span><span class="p">(</span>
                <span class="n">country_results</span><span class="o">=</span><span class="n">country_results</span><span class="p">,</span>
                <span class="n">adjust_for_unmodelled_innovation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">innovation_on</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>


    <span class="k">def</span> <span class="nf">portfolio_projection_approach_c</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funding_fraction</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PortfolioProjection</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the PortfolioProjection For Approach C: i.e., the funding fraction is the same in all countries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">country_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_country_projection_given_funding_fraction</span><span class="p">(</span><span class="n">funding_fraction</span><span class="o">=</span><span class="n">funding_fraction</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PortfolioProjection</span><span class="p">(</span>
            <span class="n">tgf_funding_by_country</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># In this scenario, we do not know the split between TGF and non-TGF sources</span>
            <span class="n">non_tgf_funding_by_country</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">country_results</span><span class="o">=</span><span class="n">country_results</span><span class="p">,</span>
            <span class="n">portfolio_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_portfolio_results</span><span class="p">(</span>
                <span class="n">country_results</span><span class="o">=</span><span class="n">country_results</span><span class="p">,</span>
                <span class="n">adjust_for_unmodelled_innovation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">innovation_on</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>


    <span class="k">def</span> <span class="nf">portfolio_projection_counterfactual</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PortfolioProjection</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a PortfolioProjection for a chosen counterfactual scenario.&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;scenario_descriptor&#39;</span><span class="p">),</span>\
            <span class="sa">f</span><span class="s2">&quot;Counterfactual </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> not found in model results.&quot;</span>

        <span class="c1"># Create dict of country_results corresponding to the counterfactual scenario</span>
        <span class="n">country_results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">countries</span><span class="p">:</span>

            <span class="n">model_projection</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">indicator</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">country</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">indicator</span><span class="p">)]</span>
                    <span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;funding_fraction&#39;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;central&#39;</span><span class="p">:</span> <span class="s1">&#39;model_central&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="s1">&#39;model_low&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="s1">&#39;model_high&#39;</span><span class="p">})</span>
                <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">indicators</span>
            <span class="p">}</span>

            <span class="n">country_results</span><span class="p">[</span><span class="n">country</span><span class="p">]</span> <span class="o">=</span> <span class="n">CountryProjection</span><span class="p">(</span>
                <span class="n">model_projection</span><span class="o">=</span><span class="n">model_projection</span><span class="p">,</span>
                <span class="n">funding</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">PortfolioProjection</span><span class="p">(</span>
            <span class="n">tgf_funding_by_country</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">countries</span><span class="p">},</span>
            <span class="n">non_tgf_funding_by_country</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">countries</span><span class="p">},</span>
            <span class="n">country_results</span><span class="o">=</span><span class="n">country_results</span><span class="p">,</span>
            <span class="n">portfolio_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_portfolio_results</span><span class="p">(</span><span class="n">country_results</span><span class="p">,</span> <span class="n">adjust_for_unmodelled_innovation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">dump_everything_to_xlsx</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">filename</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dump everything into an Excel file.&quot;&quot;&quot;</span>
        <span class="n">DumpAnalysisToExcel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_approach_b</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ApproachB</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the object `ApproachB` so that other features of it can be accessed conveniently.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ApproachB</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data_frames_for_approach_b</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get_data_frames_for_approach_b</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns dict of dataframes needed for using the `ApproachB` class. This is where the quantities are</span>
<span class="sd">        computed that summarises the performance of each country under each funding_fraction and the GP, which forms</span>
<span class="sd">        the basis of the optimisation.&quot;&quot;&quot;</span>

        <span class="c1"># ---------------</span>
        <span class="c1"># Get parameters:</span>
        <span class="n">force_monotonic_decreasing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FORCE_MONOTONIC_DECREASING&quot;</span><span class="p">)</span>
        <span class="n">years_for_obj_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;YEARS_FOR_OBJ_FUNC&quot;</span><span class="p">)</span>
        <span class="c1"># ---------------</span>

        <span class="c1"># get budgets as data-frames</span>
        <span class="n">tgf_budgets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgf_funding</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">non_tgf_budgets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_tgf_funding</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># Create Model Results df: country|cases|deaths|cost (multiple row per country, one for each costing value),</span>
        <span class="c1"># with...</span>
        <span class="c1"># * cost being the sums of cost within the years specified by `years_for_funding` (i.e. the years of the</span>
        <span class="c1">#   replenishment).</span>
        <span class="c1"># * cases and death being sums within the years specified by `years_for_obj_func` (i.e. the period over which</span>
        <span class="c1">#   we wish to &quot;compete&quot; the different funding allocations).</span>

        <span class="c1"># Summarise cases/death for each funding_fraction: sums within  `years_for_obj_func`</span>
        <span class="n">cases_and_deaths</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span>
                    <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                    <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                    <span class="n">years_for_obj_func</span><span class="p">,</span>
                    <span class="p">[</span><span class="s2">&quot;cases&quot;</span><span class="p">,</span> <span class="s2">&quot;deaths&quot;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">][</span><span class="s2">&quot;central&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;funding_fraction&quot;</span><span class="p">,</span> <span class="s2">&quot;country&quot;</span><span class="p">,</span> <span class="s2">&quot;indicator&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s2">&quot;indicator&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Summarise cost for each funding_fraction: sums within `self.years_for_funding`</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span>
                    <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                    <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">years_for_funding</span><span class="p">,</span>
                    <span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">][</span><span class="s2">&quot;central&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;funding_fraction&quot;</span><span class="p">,</span> <span class="s2">&quot;country&quot;</span><span class="p">,</span> <span class="s2">&quot;indicator&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s2">&quot;indicator&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># join these two dataframes:</span>
        <span class="n">model_results</span> <span class="o">=</span> <span class="n">cases_and_deaths</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">costs</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;country&quot;</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Handle_out_of_bounds_costs`: Insert a set of records for zero-funding with same results as for 10% funding</span>
        <span class="c1"># and a set of records with float(&#39;inf&#39;) costs for with the same results as the highest funding level</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_out_of_bounds_costs</span><span class="p">:</span>
            <span class="n">zero_funding_records</span> <span class="o">=</span> <span class="n">model_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_results</span><span class="p">[</span><span class="s1">&#39;funding_fraction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">zero_funding_records</span><span class="p">[</span><span class="s1">&#39;funding_fraction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">zero_funding_records</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">inf_funding_records</span> <span class="o">=</span> <span class="n">model_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_results</span><span class="p">[</span><span class="s1">&#39;funding_fraction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">inf_funding_records</span><span class="p">[</span><span class="s1">&#39;funding_fraction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="n">inf_funding_records</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

            <span class="n">model_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">model_results</span><span class="p">,</span> <span class="n">zero_funding_records</span><span class="p">,</span> <span class="n">inf_funding_records</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;country&quot;</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Force_monotonic_decreasing`: Within the results for each country, force that cases and deaths are</span>
        <span class="c1">#  monotonically decreasing with costs.</span>
        <span class="k">if</span> <span class="n">force_monotonic_decreasing</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">raw_sorted_on_cost</span> <span class="o">=</span> <span class="n">model_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_results</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">country</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">,</span> <span class="s1">&#39;deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;cases&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cost&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">model_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_results</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">country</span><span class="p">,</span> <span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_sorted_on_cost</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
                <span class="n">model_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_results</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">country</span><span class="p">,</span> <span class="s1">&#39;cases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_sorted_on_cost</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cummin</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
                <span class="n">model_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_results</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">country</span><span class="p">,</span> <span class="s1">&#39;deaths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_sorted_on_cost</span><span class="p">[</span><span class="s1">&#39;deaths&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cummin</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Tidy-up (sort and drop any duplicates)</span>
        <span class="n">model_results</span> <span class="o">=</span> <span class="n">model_results</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span> \
                                     <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;funding_fraction&quot;</span><span class="p">])</span> \
                                     <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">,</span> <span class="s1">&#39;cost&#39;</span><span class="p">])</span> \
                                     <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;country&quot;</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">])[[</span><span class="s2">&quot;country&quot;</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">,</span> <span class="s2">&quot;cases&quot;</span><span class="p">,</span> <span class="s2">&quot;deaths&quot;</span><span class="p">]]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;tgf_budgets&quot;</span><span class="p">:</span> <span class="n">tgf_budgets</span><span class="p">,</span>
            <span class="s2">&quot;non_tgf_budgets&quot;</span><span class="p">:</span> <span class="n">non_tgf_budgets</span><span class="p">,</span>
            <span class="s2">&quot;model_results&quot;</span><span class="p">:</span> <span class="n">model_results</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_get_country_projections_given_funding_dollar_amounts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">total_funding_by_country</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CountryProjection</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dict of CountryProjections given specified total funding dollar amounts to each country.&quot;&quot;&quot;</span>

        <span class="c1"># Collect results for each country</span>
        <span class="n">country_results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">country</span><span class="p">,</span> <span class="n">total_dollar_funding</span> <span class="ow">in</span> <span class="n">total_funding_by_country</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">country</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">countries</span><span class="p">:</span>
                <span class="c1"># Skip a country that is included in the funding data but not included in the model results</span>
                <span class="k">continue</span>

            <span class="n">model_projection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emulators</span><span class="p">[</span><span class="n">country</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">dollars</span><span class="o">=</span><span class="n">total_dollar_funding</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">country_projection</span> <span class="o">=</span> <span class="n">CountryProjection</span><span class="p">(</span>
                <span class="n">model_projection</span><span class="o">=</span><span class="n">model_projection</span><span class="p">,</span>
                <span class="n">funding</span><span class="o">=</span><span class="n">total_dollar_funding</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">country_results</span><span class="p">[</span><span class="n">country</span><span class="p">]</span> <span class="o">=</span> <span class="n">country_projection</span>

        <span class="k">return</span> <span class="n">country_results</span>

    <span class="k">def</span> <span class="nf">_get_country_projection_given_funding_fraction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funding_fraction</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CountryProjection</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dict of CountryProjections given a specified funding_fraction, which is the same in all countries&quot;&quot;&quot;</span>
        <span class="n">country_results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">countries</span><span class="p">:</span>
            <span class="n">model_projection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emulators</span><span class="p">[</span><span class="n">country</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">funding_fraction</span><span class="o">=</span><span class="n">funding_fraction</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">country_projection</span> <span class="o">=</span> <span class="n">CountryProjection</span><span class="p">(</span>
                <span class="n">model_projection</span><span class="o">=</span><span class="n">model_projection</span><span class="p">,</span>
                <span class="n">funding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># could find this from self.emulators[country]._lookup_dollars_to_funding_fraction[1.0]</span>
            <span class="p">)</span>
            <span class="n">country_results</span><span class="p">[</span><span class="n">country</span><span class="p">]</span> <span class="o">=</span> <span class="n">country_projection</span>
        <span class="k">return</span> <span class="n">country_results</span>

    <span class="k">def</span> <span class="nf">_make_portfolio_results</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">country_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CountryProjection</span><span class="p">],</span>
            <span class="n">adjust_for_unmodelled_innovation</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; This function generates portfolio level results. This included summing up variables across countries,</span>
<span class="sd">        scaling up for non-modelled countries, and doing the adjustment for GP-related innovation. &quot;&quot;&quot;</span>

        <span class="n">actual_without_innovation</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scale_up_for_non_modelled_countries</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_summing_up_countries</span><span class="p">(</span><span class="n">country_results</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">name</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">adjust_for_unmodelled_innovation</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">actual_without_innovation</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get the fully funded version of the model output</span>
            <span class="n">scenario_that_represents_full_impact_including_innovation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SCENARIO_THAT_REPRESENTS_FULL_IMPACT_INCLUDING_INNOVATION&#39;</span><span class="p">)</span>
            <span class="n">full_funding_without_innovation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_projection_counterfactual</span><span class="p">(</span><span class="n">scenario_that_represents_full_impact_including_innovation</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_adj_for_innovations</span><span class="p">(</span>
                    <span class="n">actual_without_innovation</span><span class="o">=</span><span class="n">actual_without_innovation</span><span class="p">,</span>
                    <span class="n">full_funding_without_innovation</span><span class="o">=</span><span class="n">full_funding_without_innovation</span><span class="p">,</span>
                    <span class="n">gp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gp</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scale_up_for_non_modelled_countries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">country_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CountryProjection</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; This scales the modelled results to non-modelled countries for the epi indicators. &quot;&quot;&quot;</span>

        <span class="c1"># Get the first year of the model and list of epi indicators</span>
        <span class="n">first_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;START_YEAR&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;GP&#39;</span><span class="p">):</span>
            <span class="n">first_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GP_START_YEAR&quot;</span><span class="p">)</span>

        <span class="c1"># Get the indicators that should be scaled</span>
        <span class="n">indicator_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get_indicators_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span><span class="p">)</span><span class="o">.</span><span class="n">use_scaling</span>
        <span class="n">indicator_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">indicator_list</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">indicator_list</span> <span class="o">=</span> <span class="n">indicator_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indicator_list</span><span class="p">[</span><span class="s1">&#39;use_scaling&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
        <span class="n">indicator_list</span> <span class="o">=</span> <span class="n">indicator_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Filter partner data to the corresponding year and epi indicators, summed across countries and turned</span>
        <span class="c1"># into a dictionary</span>
        <span class="n">df_partner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">partner_data</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">first_year</span><span class="p">,</span> <span class="n">indicator_list</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;indicator&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()[</span><span class="s1">&#39;central&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># This loop scaled all epi indicators to non-modelled countries</span>
        <span class="n">adj_results_portfolio</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">indicator</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">country_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">indicator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">indicator_list</span><span class="p">:</span>
                <span class="n">adj_results_portfolio</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># do scaling:</span>
                <span class="n">adj_results_portfolio</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span> <span class="o">*</span> <span class="p">(</span><span class="n">df_partner</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">first_year</span><span class="p">,</span> <span class="s1">&#39;model_central&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">adj_results_portfolio</span>

    <span class="k">def</span> <span class="nf">_adj_for_innovations</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">actual_without_innovation</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CountryProjection</span><span class="p">],</span>
            <span class="n">full_funding_without_innovation</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CountryProjection</span><span class="p">],</span>
            <span class="n">gp</span><span class="p">:</span> <span class="n">Gp</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; This will make the necessary adjustments for innovations assumed to come in within the partner GP. &quot;&quot;&quot;</span>


        <span class="n">sigmoid_scaling</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;START_YEAR&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;END_YEAR&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NEW_INNOVATIONS_SCALING_FACTORS&quot;</span><span class="p">)</span>
            <span class="p">))</span>
        <span class="p">)</span>

        <span class="n">INDICATORS_FOR_ADJ_FOR_INNOVATIONS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators_for_adj_for_innovations</span>

        <span class="n">adj_country_results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">indicator</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">actual_without_innovation</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">indicator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">INDICATORS_FOR_ADJ_FOR_INNOVATIONS</span><span class="p">:</span>
                <span class="c1"># Do not do any adjustment</span>
                <span class="n">adj_country_results</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Do the adjustment for new innovations</span>

                <span class="c1"># Set first year of model output</span>
                <span class="n">expected_first_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;START_YEAR&quot;</span><span class="p">)</span>

                <span class="c1"># Work out correction needed for non-modelled innovations:</span>
                <span class="n">full_funding</span> <span class="o">=</span> <span class="n">full_funding_without_innovation</span><span class="o">.</span><span class="n">portfolio_results</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span>
                <span class="n">_gp_df</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="n">_gp</span> <span class="o">=</span> <span class="n">_gp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">_gp_df</span><span class="o">.</span><span class="n">indicator</span> <span class="o">==</span> <span class="n">indicator</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;central&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)[</span><span class="s1">&#39;central&#39;</span><span class="p">]</span>
                <span class="n">_gp</span> <span class="o">=</span> <span class="n">_gp</span><span class="p">[</span><span class="n">_gp</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">expected_first_year</span><span class="p">]</span>  <span class="c1"># Ensure all dfs have same length</span>
                <span class="n">step_one</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span> <span class="o">/</span> <span class="n">full_funding</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">_gp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">step_two</span> <span class="o">=</span> <span class="n">df</span> <span class="o">-</span> <span class="p">(</span><span class="n">df</span> <span class="o">-</span> <span class="n">step_one</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">sigmoid_scaling</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Over-write the lower and upper bounds so they are the same distance as the modelled distance before applying the sigmoidal adjustment</span>
                <span class="c1"># If not, the lower bounds and upper bounds can behave strangely</span>

                <span class="c1"># First capture the distance from central to LB and Ub from unadjusted</span>
                <span class="n">distance_low</span>  <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;model_central&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;model_low&#39;</span><span class="p">]</span>
                <span class="n">distance_upper</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;model_high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;model_central&#39;</span><span class="p">]</span>

                <span class="n">step_two</span><span class="p">[</span><span class="s1">&#39;model_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_two</span><span class="p">[</span><span class="s1">&#39;model_central&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">distance_low</span>
                <span class="n">step_two</span><span class="p">[</span><span class="s1">&#39;model_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_two</span><span class="p">[</span><span class="s1">&#39;model_central&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">distance_upper</span>

                <span class="c1"># Add adjusted time series to the dataframe</span>
                <span class="n">adj_country_results</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_two</span>

        <span class="k">return</span> <span class="n">adj_country_results</span>

    <span class="k">def</span> <span class="nf">_summing_up_countries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">country_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CountryProjection</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; This will sum up all the country results to get the portolfio-level results. This will use the adjusted</span>
<span class="sd">        country results and be used to generate uncertainty. &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_compute_mean_and_ci</span><span class="p">(</span><span class="n">_df_for_year</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;This helper function accepts a dataframe for one year of model results for each country, and returns a</span>
<span class="sd">            dict summarising the statistic across the countries, as a mean low/high range.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">model_central</span> <span class="o">=</span> <span class="n">_df_for_year</span><span class="p">[</span><span class="s2">&quot;model_central&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="c1"># Then we do the SDs. CAUTION for the first SD it has to be 1.96 as the assumptions that the model LB and UB</span>
            <span class="c1"># correspond to 95% confidence intervals</span>
            <span class="n">_sds</span> <span class="o">=</span> <span class="p">((</span><span class="n">_df_for_year</span><span class="o">.</span><span class="n">model_high</span> <span class="o">-</span> <span class="n">_df_for_year</span><span class="o">.</span><span class="n">model_low</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mf">1.96</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
            <span class="n">sd_for_year</span> <span class="o">=</span> <span class="p">(</span>
                                  <span class="n">matmul</span><span class="p">(</span><span class="n">_sds</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="n">rho_btw_countries</span>
                                  <span class="o">+</span> <span class="p">(</span><span class="n">_sds</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rho_btw_countries</span><span class="p">)</span>
                          <span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="n">model_low</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">model_central</span> <span class="o">-</span> <span class="n">z_value</span> <span class="o">*</span> <span class="n">sd_for_year</span><span class="p">))</span>
            <span class="n">model_high</span> <span class="o">=</span> <span class="n">model_central</span> <span class="o">+</span> <span class="n">z_value</span> <span class="o">*</span> <span class="n">sd_for_year</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;model_central&#39;</span><span class="p">:</span> <span class="n">model_central</span><span class="p">,</span>
                <span class="s1">&#39;model_low&#39;</span><span class="p">:</span> <span class="n">model_low</span><span class="p">,</span>
                <span class="s1">&#39;model_high&#39;</span><span class="p">:</span> <span class="n">model_high</span>
            <span class="p">}</span>

        <span class="c1"># Define years and parameters we need</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">first_year</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;START_YEAR&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;GP&#39;</span><span class="p">):</span>            <span class="n">first_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GP_START_YEAR&quot;</span><span class="p">)</span>
        <span class="n">last_year</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;END_YEAR&quot;</span><span class="p">)</span>
        <span class="n">z_value</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Z_VALUE&quot;</span><span class="p">)</span>
        <span class="n">rho_btw_countries</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;RHO_BETWEEN_COUNTRIES_WITHIN_DISEASE&quot;</span><span class="p">)</span>

        <span class="n">portfolio_results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># Defining the list of indicators and countries for the loop</span>
        <span class="n">indicators</span> <span class="o">=</span> <span class="n">country_results</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">country_results</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">model_projection</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">types_lookup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">countries</span> <span class="o">=</span> <span class="n">country_results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="c1"># Extracting all values for each indicator across all countries, if we should do an aggregation</span>
        <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">indicators</span><span class="p">:</span>
            <span class="n">type_of_indicator_is_count</span> <span class="o">=</span> <span class="n">types_lookup</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;count&#39;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">type_of_indicator_is_count</span><span class="p">:</span>
                <span class="c1"># Do nothing if the indicator is not aggregating arithmetically (i.e., is a count).</span>
                <span class="k">continue</span>

            <span class="n">dfs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="n">countries</span><span class="p">:</span>
                <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">country_results</span><span class="p">[</span><span class="n">country</span><span class="p">]</span><span class="o">.</span><span class="n">model_projection</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="nb">slice</span><span class="p">(</span><span class="n">first_year</span><span class="p">,</span> <span class="n">last_year</span><span class="p">),</span>
                        <span class="p">[</span><span class="s1">&#39;model_central&#39;</span><span class="p">,</span> <span class="s1">&#39;model_high&#39;</span><span class="p">,</span> <span class="s1">&#39;model_low&#39;</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="p">)</span>

            <span class="c1"># Put all the values for a given indicator together into one df</span>
            <span class="n">all_dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>

            <span class="c1"># Aggregate by year:</span>
            <span class="n">_res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">first_year</span><span class="p">,</span> <span class="n">last_year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">_res</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_dfs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">year</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">_compute_mean_and_ci</span><span class="p">)</span>

            <span class="n">portfolio_results</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">_res</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="k">return</span> <span class="n">portfolio_results</span>

    <span class="k">def</span> <span class="nf">get_partner</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns data-frame of the partner data that are needed for reporting.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span> <span class="o">==</span> <span class="s1">&#39;HIV&#39;</span><span class="p">:</span>
            <span class="n">indicator_partner</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">,</span> <span class="s1">&#39;deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;hivneg&#39;</span><span class="p">,</span> <span class="s1">&#39;population&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span> <span class="o">==</span> <span class="s1">&#39;TB&#39;</span><span class="p">:</span>
            <span class="n">indicator_partner</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">,</span> <span class="s1">&#39;deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;deathshivneg&#39;</span><span class="p">,</span> <span class="s1">&#39;population&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span> <span class="o">==</span> <span class="s1">&#39;MALARIA&#39;</span><span class="p">:</span>
            <span class="n">indicator_partner</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">,</span> <span class="s1">&#39;deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;par&#39;</span><span class="p">]</span>

        <span class="n">expected_first_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GRAPH_FIRST_YEAR&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span>
        <span class="n">expected_last_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;START_YEAR&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">partner_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">partner_data</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">expected_first_year</span><span class="p">,</span> <span class="n">expected_last_year</span><span class="p">),</span> <span class="n">indicator_partner</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;indicator&#39;</span><span class="p">])[</span><span class="s1">&#39;central&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">partner_data</span>

    <span class="k">def</span> <span class="nf">get_gp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns data-frame of the GP elements that are needed for reporting.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span> <span class="o">!=</span> <span class="s1">&#39;HIV&#39;</span><span class="p">:</span>
            <span class="n">gp_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;central&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get GP for HIV</span>
            <span class="n">gp_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_projection_counterfactual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_GP_SCENARIO</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Convert to the same format as other diseases</span>
            <span class="n">gp_data</span> <span class="o">=</span> <span class="n">gp_data</span><span class="o">.</span><span class="n">portfolio_results</span>
            <span class="n">gp_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">gp_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;level_0&#39;</span><span class="p">:</span> <span class="s1">&#39;key&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">gp_data</span> <span class="o">=</span> <span class="n">gp_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;model_low&#39;</span><span class="p">,</span> <span class="s1">&#39;model_high&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">gp_data</span> <span class="o">=</span> <span class="n">gp_data</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;model_central&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gp_data</span>

    <span class="k">def</span> <span class="nf">get_counterfactual_lives_saved_malaria</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the CF time series to compute lives saved for malaria&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span> <span class="o">!=</span> <span class="s2">&quot;MALARIA&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Get partner mortality data</span>
        <span class="n">mortality_partner_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">partner_data</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="mi">2000</span><span class="p">,</span> <span class="s2">&quot;mortality&quot;</span><span class="p">),</span> <span class="s2">&quot;central&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scenario_descriptor&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;indicator&quot;</span><span class="p">])</span>
        <span class="c1"># 2000 is hard-coded as the year as that is intrinsic to the analysis.</span>

        <span class="c1"># TODO: make mean of funding fractions?</span>
        <span class="c1"># Set years of model output</span>
        <span class="n">expected_first_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;START_YEAR&quot;</span><span class="p">)</span>
        <span class="n">expected_last_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;END_YEAR&quot;</span><span class="p">)</span>

        <span class="c1"># First adjust model data to baseline partner data</span>

        <span class="c1"># Get the model estimates for par for IC scenario and generate mean across funding fractions</span>
        <span class="n">par_model_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">expected_first_year</span><span class="p">,</span> <span class="n">expected_last_year</span><span class="p">),</span> <span class="s2">&quot;par&quot;</span><span class="p">),</span> <span class="s2">&quot;central&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>

        <span class="c1"># Then get the estimates from baseline from model and partner data to compute adjustment ratio</span>
        <span class="n">par_firstyear_partner_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">partner_data</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">expected_first_year</span><span class="p">,</span> <span class="s2">&quot;par&quot;</span><span class="p">),</span> <span class="s2">&quot;central&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scenario_descriptor&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;indicator&quot;</span><span class="p">])</span>

        <span class="n">par_firstyear_model_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">expected_first_year</span><span class="p">,</span> <span class="s2">&quot;par&quot;</span><span class="p">),</span> <span class="s2">&quot;central&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scenario_descriptor&quot;</span><span class="p">,</span> <span class="s2">&quot;funding_fraction&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;indicator&quot;</span><span class="p">])</span>

        <span class="n">ratio</span> <span class="o">=</span> <span class="n">par_firstyear_partner_data</span> <span class="o">/</span> <span class="n">par_firstyear_model_data</span>

        <span class="c1"># Compute modelled par that have been adjusted to baseline partner data</span>
        <span class="n">adj_par_data_model</span> <span class="o">=</span> <span class="n">par_model_data</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Now compute deaths from the above as a CF time series for lives saved</span>
        <span class="n">adjusted_mortality</span> <span class="o">=</span> <span class="n">adj_par_data_model</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">mortality_partner_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">adjusted_mortality_total</span> <span class="o">=</span> <span class="n">adjusted_mortality</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">adjusted_mortality_total</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">adjusted_mortality_total</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">adjusted_mortality_total</span>

    <span class="k">def</span> <span class="nf">get_counterfactual_infections_averted_malaria</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the CF time series to compute infections averted for malaria&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span> <span class="o">!=</span> <span class="s2">&quot;MALARIA&quot;</span><span class="p">:</span>

            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Get partner mortality data</span>
        <span class="c1"># Set first year of model output</span>
        <span class="n">expected_first_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;START_YEAR&quot;</span><span class="p">)</span>
        <span class="n">expected_last_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;END_YEAR&quot;</span><span class="p">)</span>

        <span class="n">incidence_partner_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">partner_data</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">expected_first_year</span><span class="p">,</span> <span class="s2">&quot;incidence&quot;</span><span class="p">),</span> <span class="s2">&quot;central&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scenario_descriptor&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;indicator&quot;</span><span class="p">])</span>

        <span class="c1"># TODO: make mean of funding fractions?</span>
        <span class="c1"># First adjust model data to baseline partner data</span>
        <span class="c1"># Get the model estimates for par for IC scenario and generate mean across funding fractions</span>
        <span class="n">par_model_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">expected_first_year</span><span class="p">,</span> <span class="n">expected_last_year</span><span class="p">),</span> <span class="s2">&quot;par&quot;</span><span class="p">),</span> <span class="s1">&#39;central&#39;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>

        <span class="c1"># Then get the estimates from baseline from model and partner data to compute adjustment ratio</span>
        <span class="n">par_firstyear_partner_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">partner_data</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">expected_first_year</span><span class="p">,</span> <span class="s2">&quot;par&quot;</span><span class="p">),</span> <span class="s2">&quot;central&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scenario_descriptor&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;indicator&quot;</span><span class="p">])</span>

        <span class="n">par_firstyear_model_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">expected_first_year</span><span class="p">,</span> <span class="s2">&quot;par&quot;</span><span class="p">),</span> <span class="s2">&quot;central&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scenario_descriptor&quot;</span><span class="p">,</span> <span class="s2">&quot;funding_fraction&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;indicator&quot;</span><span class="p">])</span>

        <span class="n">ratio</span> <span class="o">=</span> <span class="n">par_firstyear_partner_data</span> <span class="o">/</span> <span class="n">par_firstyear_model_data</span>

        <span class="c1"># Compute modelled par that have been adjusted to baseline partner data</span>
        <span class="n">adj_par_data_model</span> <span class="o">=</span> <span class="n">par_model_data</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Now compute deaths from the above as a CF time series for lives saved</span>
        <span class="n">adjusted_incidence</span> <span class="o">=</span> <span class="n">adj_par_data_model</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">incidence_partner_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">adjusted_incidence_total</span> <span class="o">=</span> <span class="n">adjusted_incidence</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">adjusted_incidence_total</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">adjusted_incidence_total</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">adjusted_incidence_total</span>

    <span class="k">def</span> <span class="nf">make_diagnostic_report</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">plt_show</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a report that compares the results from Approach A and B (and alternative optimisation methods for</span>
<span class="sd">        Approach B if these are specified).</span>
<span class="sd">        :param plt_show: determines whether to show the plot</span>
<span class="sd">        :param filename: filename to save the report to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the approach_b object</span>
        <span class="n">approach_b_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_approach_b</span><span class="p">()</span>

        <span class="c1"># Run the report, specifying whether to plot graphs, the filename, and passing through any other kwargs</span>
        <span class="c1"># Suppress the returned results as the purpose of this function is generating the report.</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">approach_b_object</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">plt_show</span><span class="o">=</span><span class="n">plt_show</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
            <span class="n">methods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;APPROACH_B_METHODS&#39;</span><span class="p">),</span>
            <span class="n">provide_best_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h3 id="src.tgftools.analysis.Analysis.dump_everything_to_xlsx" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">dump_everything_to_xlsx</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Dump everything into an Excel file.</p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/analysis.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">dump_everything_to_xlsx</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dump everything into an Excel file.&quot;&quot;&quot;</span>
    <span class="n">DumpAnalysisToExcel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="src.tgftools.analysis.Analysis.filter_funding_data_for_non_modelled_countries" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">filter_funding_data_for_non_modelled_countries</span><span class="p">(</span><span class="n">funding_data_object</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns a funding data object that has been filtered for countries that are not declared as the modelled
countries for that disease.</p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/analysis.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">filter_funding_data_for_non_modelled_countries</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">funding_data_object</span><span class="p">:</span> <span class="n">TgfFunding</span> <span class="o">|</span> <span class="n">NonTgfFunding</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TgfFunding</span> <span class="o">|</span> <span class="n">NonTgfFunding</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a funding data object that has been filtered for countries that are not declared as the modelled</span>
<span class="sd">    countries for that disease.&quot;&quot;&quot;</span>
    <span class="n">list_of_modelled_countries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get_modelled_countries_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span><span class="p">)</span>
    <span class="n">funding_data_object</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">funding_data_object</span><span class="p">)</span>
    <span class="n">funding_data_object</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">funding_data_object</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">funding_data_object</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_of_modelled_countries</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">funding_data_object</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="src.tgftools.analysis.Analysis.get_counterfactual_infections_averted_malaria" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_counterfactual_infections_averted_malaria</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Return the CF time series to compute infections averted for malaria</p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/analysis.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_counterfactual_infections_averted_malaria</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return the CF time series to compute infections averted for malaria&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span> <span class="o">!=</span> <span class="s2">&quot;MALARIA&quot;</span><span class="p">:</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="c1"># Get partner mortality data</span>
    <span class="c1"># Set first year of model output</span>
    <span class="n">expected_first_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;START_YEAR&quot;</span><span class="p">)</span>
    <span class="n">expected_last_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;END_YEAR&quot;</span><span class="p">)</span>

    <span class="n">incidence_partner_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">partner_data</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">expected_first_year</span><span class="p">,</span> <span class="s2">&quot;incidence&quot;</span><span class="p">),</span> <span class="s2">&quot;central&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scenario_descriptor&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;indicator&quot;</span><span class="p">])</span>

    <span class="c1"># TODO: make mean of funding fractions?</span>
    <span class="c1"># First adjust model data to baseline partner data</span>
    <span class="c1"># Get the model estimates for par for IC scenario and generate mean across funding fractions</span>
    <span class="n">par_model_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">expected_first_year</span><span class="p">,</span> <span class="n">expected_last_year</span><span class="p">),</span> <span class="s2">&quot;par&quot;</span><span class="p">),</span> <span class="s1">&#39;central&#39;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>

    <span class="c1"># Then get the estimates from baseline from model and partner data to compute adjustment ratio</span>
    <span class="n">par_firstyear_partner_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">partner_data</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">expected_first_year</span><span class="p">,</span> <span class="s2">&quot;par&quot;</span><span class="p">),</span> <span class="s2">&quot;central&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scenario_descriptor&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;indicator&quot;</span><span class="p">])</span>

    <span class="n">par_firstyear_model_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">expected_first_year</span><span class="p">,</span> <span class="s2">&quot;par&quot;</span><span class="p">),</span> <span class="s2">&quot;central&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scenario_descriptor&quot;</span><span class="p">,</span> <span class="s2">&quot;funding_fraction&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;indicator&quot;</span><span class="p">])</span>

    <span class="n">ratio</span> <span class="o">=</span> <span class="n">par_firstyear_partner_data</span> <span class="o">/</span> <span class="n">par_firstyear_model_data</span>

    <span class="c1"># Compute modelled par that have been adjusted to baseline partner data</span>
    <span class="n">adj_par_data_model</span> <span class="o">=</span> <span class="n">par_model_data</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Now compute deaths from the above as a CF time series for lives saved</span>
    <span class="n">adjusted_incidence</span> <span class="o">=</span> <span class="n">adj_par_data_model</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">incidence_partner_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">adjusted_incidence_total</span> <span class="o">=</span> <span class="n">adjusted_incidence</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">adjusted_incidence_total</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">adjusted_incidence_total</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">adjusted_incidence_total</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="src.tgftools.analysis.Analysis.get_counterfactual_lives_saved_malaria" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_counterfactual_lives_saved_malaria</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Return the CF time series to compute lives saved for malaria</p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/analysis.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_counterfactual_lives_saved_malaria</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return the CF time series to compute lives saved for malaria&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span> <span class="o">!=</span> <span class="s2">&quot;MALARIA&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="c1"># Get partner mortality data</span>
    <span class="n">mortality_partner_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">partner_data</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="mi">2000</span><span class="p">,</span> <span class="s2">&quot;mortality&quot;</span><span class="p">),</span> <span class="s2">&quot;central&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scenario_descriptor&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;indicator&quot;</span><span class="p">])</span>
    <span class="c1"># 2000 is hard-coded as the year as that is intrinsic to the analysis.</span>

    <span class="c1"># TODO: make mean of funding fractions?</span>
    <span class="c1"># Set years of model output</span>
    <span class="n">expected_first_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;START_YEAR&quot;</span><span class="p">)</span>
    <span class="n">expected_last_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;END_YEAR&quot;</span><span class="p">)</span>

    <span class="c1"># First adjust model data to baseline partner data</span>

    <span class="c1"># Get the model estimates for par for IC scenario and generate mean across funding fractions</span>
    <span class="n">par_model_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">expected_first_year</span><span class="p">,</span> <span class="n">expected_last_year</span><span class="p">),</span> <span class="s2">&quot;par&quot;</span><span class="p">),</span> <span class="s2">&quot;central&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>

    <span class="c1"># Then get the estimates from baseline from model and partner data to compute adjustment ratio</span>
    <span class="n">par_firstyear_partner_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">partner_data</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">expected_first_year</span><span class="p">,</span> <span class="s2">&quot;par&quot;</span><span class="p">),</span> <span class="s2">&quot;central&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scenario_descriptor&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;indicator&quot;</span><span class="p">])</span>

    <span class="n">par_firstyear_model_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">expected_first_year</span><span class="p">,</span> <span class="s2">&quot;par&quot;</span><span class="p">),</span> <span class="s2">&quot;central&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scenario_descriptor&quot;</span><span class="p">,</span> <span class="s2">&quot;funding_fraction&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;indicator&quot;</span><span class="p">])</span>

    <span class="n">ratio</span> <span class="o">=</span> <span class="n">par_firstyear_partner_data</span> <span class="o">/</span> <span class="n">par_firstyear_model_data</span>

    <span class="c1"># Compute modelled par that have been adjusted to baseline partner data</span>
    <span class="n">adj_par_data_model</span> <span class="o">=</span> <span class="n">par_model_data</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Now compute deaths from the above as a CF time series for lives saved</span>
    <span class="n">adjusted_mortality</span> <span class="o">=</span> <span class="n">adj_par_data_model</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">mortality_partner_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">adjusted_mortality_total</span> <span class="o">=</span> <span class="n">adjusted_mortality</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">adjusted_mortality_total</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">adjusted_mortality_total</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">adjusted_mortality_total</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="src.tgftools.analysis.Analysis.get_data_frames_for_approach_b" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_data_frames_for_approach_b</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns dict of dataframes needed for using the <code>ApproachB</code> class. This is where the quantities are
computed that summarises the performance of each country under each funding_fraction and the GP, which forms
the basis of the optimisation.</p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/analysis.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_data_frames_for_approach_b</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns dict of dataframes needed for using the `ApproachB` class. This is where the quantities are</span>
<span class="sd">    computed that summarises the performance of each country under each funding_fraction and the GP, which forms</span>
<span class="sd">    the basis of the optimisation.&quot;&quot;&quot;</span>

    <span class="c1"># ---------------</span>
    <span class="c1"># Get parameters:</span>
    <span class="n">force_monotonic_decreasing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FORCE_MONOTONIC_DECREASING&quot;</span><span class="p">)</span>
    <span class="n">years_for_obj_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;YEARS_FOR_OBJ_FUNC&quot;</span><span class="p">)</span>
    <span class="c1"># ---------------</span>

    <span class="c1"># get budgets as data-frames</span>
    <span class="n">tgf_budgets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgf_funding</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">non_tgf_budgets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_tgf_funding</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># Create Model Results df: country|cases|deaths|cost (multiple row per country, one for each costing value),</span>
    <span class="c1"># with...</span>
    <span class="c1"># * cost being the sums of cost within the years specified by `years_for_funding` (i.e. the years of the</span>
    <span class="c1">#   replenishment).</span>
    <span class="c1"># * cases and death being sums within the years specified by `years_for_obj_func` (i.e. the period over which</span>
    <span class="c1">#   we wish to &quot;compete&quot; the different funding allocations).</span>

    <span class="c1"># Summarise cases/death for each funding_fraction: sums within  `years_for_obj_func`</span>
    <span class="n">cases_and_deaths</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span>
                <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                <span class="n">years_for_obj_func</span><span class="p">,</span>
                <span class="p">[</span><span class="s2">&quot;cases&quot;</span><span class="p">,</span> <span class="s2">&quot;deaths&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">][</span><span class="s2">&quot;central&quot;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;funding_fraction&quot;</span><span class="p">,</span> <span class="s2">&quot;country&quot;</span><span class="p">,</span> <span class="s2">&quot;indicator&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s2">&quot;indicator&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Summarise cost for each funding_fraction: sums within `self.years_for_funding`</span>
    <span class="n">costs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span>
                <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">years_for_funding</span><span class="p">,</span>
                <span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">][</span><span class="s2">&quot;central&quot;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;funding_fraction&quot;</span><span class="p">,</span> <span class="s2">&quot;country&quot;</span><span class="p">,</span> <span class="s2">&quot;indicator&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s2">&quot;indicator&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># join these two dataframes:</span>
    <span class="n">model_results</span> <span class="o">=</span> <span class="n">cases_and_deaths</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">costs</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;country&quot;</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Handle_out_of_bounds_costs`: Insert a set of records for zero-funding with same results as for 10% funding</span>
    <span class="c1"># and a set of records with float(&#39;inf&#39;) costs for with the same results as the highest funding level</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_out_of_bounds_costs</span><span class="p">:</span>
        <span class="n">zero_funding_records</span> <span class="o">=</span> <span class="n">model_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_results</span><span class="p">[</span><span class="s1">&#39;funding_fraction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">zero_funding_records</span><span class="p">[</span><span class="s1">&#39;funding_fraction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">zero_funding_records</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">inf_funding_records</span> <span class="o">=</span> <span class="n">model_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_results</span><span class="p">[</span><span class="s1">&#39;funding_fraction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">inf_funding_records</span><span class="p">[</span><span class="s1">&#39;funding_fraction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">inf_funding_records</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

        <span class="n">model_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">model_results</span><span class="p">,</span> <span class="n">zero_funding_records</span><span class="p">,</span> <span class="n">inf_funding_records</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;country&quot;</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Force_monotonic_decreasing`: Within the results for each country, force that cases and deaths are</span>
    <span class="c1">#  monotonically decreasing with costs.</span>
    <span class="k">if</span> <span class="n">force_monotonic_decreasing</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">raw_sorted_on_cost</span> <span class="o">=</span> <span class="n">model_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_results</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">country</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">,</span> <span class="s1">&#39;deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;cases&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cost&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">model_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_results</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">country</span><span class="p">,</span> <span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_sorted_on_cost</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
            <span class="n">model_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_results</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">country</span><span class="p">,</span> <span class="s1">&#39;cases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_sorted_on_cost</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cummin</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
            <span class="n">model_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_results</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">country</span><span class="p">,</span> <span class="s1">&#39;deaths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_sorted_on_cost</span><span class="p">[</span><span class="s1">&#39;deaths&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cummin</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># Tidy-up (sort and drop any duplicates)</span>
    <span class="n">model_results</span> <span class="o">=</span> <span class="n">model_results</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span> \
                                 <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;funding_fraction&quot;</span><span class="p">])</span> \
                                 <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">,</span> <span class="s1">&#39;cost&#39;</span><span class="p">])</span> \
                                 <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;country&quot;</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">])[[</span><span class="s2">&quot;country&quot;</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">,</span> <span class="s2">&quot;cases&quot;</span><span class="p">,</span> <span class="s2">&quot;deaths&quot;</span><span class="p">]]</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;tgf_budgets&quot;</span><span class="p">:</span> <span class="n">tgf_budgets</span><span class="p">,</span>
        <span class="s2">&quot;non_tgf_budgets&quot;</span><span class="p">:</span> <span class="n">non_tgf_budgets</span><span class="p">,</span>
        <span class="s2">&quot;model_results&quot;</span><span class="p">:</span> <span class="n">model_results</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="src.tgftools.analysis.Analysis.get_gp" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_gp</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns data-frame of the GP elements that are needed for reporting.</p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/analysis.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_gp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns data-frame of the GP elements that are needed for reporting.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span> <span class="o">!=</span> <span class="s1">&#39;HIV&#39;</span><span class="p">:</span>
        <span class="n">gp_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;central&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Get GP for HIV</span>
        <span class="n">gp_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_projection_counterfactual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_GP_SCENARIO</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Convert to the same format as other diseases</span>
        <span class="n">gp_data</span> <span class="o">=</span> <span class="n">gp_data</span><span class="o">.</span><span class="n">portfolio_results</span>
        <span class="n">gp_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">gp_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;level_0&#39;</span><span class="p">:</span> <span class="s1">&#39;key&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">gp_data</span> <span class="o">=</span> <span class="n">gp_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;model_low&#39;</span><span class="p">,</span> <span class="s1">&#39;model_high&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">gp_data</span> <span class="o">=</span> <span class="n">gp_data</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;model_central&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gp_data</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="src.tgftools.analysis.Analysis.get_partner" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_partner</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns data-frame of the partner data that are needed for reporting.</p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/analysis.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_partner</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns data-frame of the partner data that are needed for reporting.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span> <span class="o">==</span> <span class="s1">&#39;HIV&#39;</span><span class="p">:</span>
        <span class="n">indicator_partner</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">,</span> <span class="s1">&#39;deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;hivneg&#39;</span><span class="p">,</span> <span class="s1">&#39;population&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span> <span class="o">==</span> <span class="s1">&#39;TB&#39;</span><span class="p">:</span>
        <span class="n">indicator_partner</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">,</span> <span class="s1">&#39;deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;deathshivneg&#39;</span><span class="p">,</span> <span class="s1">&#39;population&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disease_name</span> <span class="o">==</span> <span class="s1">&#39;MALARIA&#39;</span><span class="p">:</span>
        <span class="n">indicator_partner</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">,</span> <span class="s1">&#39;deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;par&#39;</span><span class="p">]</span>

    <span class="n">expected_first_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GRAPH_FIRST_YEAR&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span>
    <span class="n">expected_last_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;START_YEAR&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">partner_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">partner_data</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_descriptor</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">expected_first_year</span><span class="p">,</span> <span class="n">expected_last_year</span><span class="p">),</span> <span class="n">indicator_partner</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;indicator&#39;</span><span class="p">])[</span><span class="s1">&#39;central&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">partner_data</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="src.tgftools.analysis.Analysis.make_diagnostic_report" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">make_diagnostic_report</span><span class="p">(</span><span class="n">plt_show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Create a report that compares the results from Approach A and B (and alternative optimisation methods for
Approach B if these are specified).
:param plt_show: determines whether to show the plot
:param filename: filename to save the report to</p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/analysis.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make_diagnostic_report</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">plt_show</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a report that compares the results from Approach A and B (and alternative optimisation methods for</span>
<span class="sd">    Approach B if these are specified).</span>
<span class="sd">    :param plt_show: determines whether to show the plot</span>
<span class="sd">    :param filename: filename to save the report to</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create the approach_b object</span>
    <span class="n">approach_b_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_approach_b</span><span class="p">()</span>

    <span class="c1"># Run the report, specifying whether to plot graphs, the filename, and passing through any other kwargs</span>
    <span class="c1"># Suppress the returned results as the purpose of this function is generating the report.</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">approach_b_object</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="n">plt_show</span><span class="o">=</span><span class="n">plt_show</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
        <span class="n">methods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;APPROACH_B_METHODS&#39;</span><span class="p">),</span>
        <span class="n">provide_best_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="src.tgftools.analysis.Analysis.portfolio_projection_approach_a" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">portfolio_projection_approach_a</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns the PortfolioProjection For Approach A: i.e., the projection for each country, given the funding
to each country when the TGF funding allocated to a country CANNOT be changed.</p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/analysis.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">portfolio_projection_approach_a</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PortfolioProjection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the PortfolioProjection For Approach A: i.e., the projection for each country, given the funding</span>
<span class="sd">    to each country when the TGF funding allocated to a country CANNOT be changed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">country_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_country_projections_given_funding_dollar_amounts</span><span class="p">(</span>
        <span class="n">total_funding_by_country</span><span class="o">=</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tgf_funding</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_tgf_funding</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">PortfolioProjection</span><span class="p">(</span>
        <span class="n">tgf_funding_by_country</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tgf_funding</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
        <span class="n">non_tgf_funding_by_country</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">non_tgf_funding</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
        <span class="n">country_results</span><span class="o">=</span><span class="n">country_results</span><span class="p">,</span>
        <span class="n">portfolio_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_portfolio_results</span><span class="p">(</span>
            <span class="n">country_results</span><span class="o">=</span><span class="n">country_results</span><span class="p">,</span>
            <span class="n">adjust_for_unmodelled_innovation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">innovation_on</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="src.tgftools.analysis.Analysis.portfolio_projection_approach_b" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">portfolio_projection_approach_b</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns the PortfolioProjection For Approach B: i.e., the projection for each country, given the funding
to each country when the TGF funding allocated to a country <em>CAN</em> be changed. Multiple methods for optimisation
may be tried, but only a single result is provided (that of the best solution found.)
:param methods: List of methods to use in approach_b (For method see <code>do_approach_b</code>)
:param optimisation_params: Dict of parameters specifying how to construct the optimisation.
See <code>_get_data_frames_for_approach_b</code></p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/analysis.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">portfolio_projection_approach_b</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PortfolioProjection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the PortfolioProjection For Approach B: i.e., the projection for each country, given the funding</span>
<span class="sd">    to each country when the TGF funding allocated to a country _CAN_ be changed. Multiple methods for optimisation</span>
<span class="sd">    may be tried, but only a single result is provided (that of the best solution found.)</span>
<span class="sd">    :param methods: List of methods to use in approach_b (For method see `do_approach_b`)</span>
<span class="sd">    :param optimisation_params: Dict of parameters specifying how to construct the optimisation.</span>
<span class="sd">    See `_get_data_frames_for_approach_b`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Use the `ApproachB` class to get the TGF funding allocations from the optimisation, getting only the best</span>
    <span class="c1"># result.</span>

    <span class="n">methods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;APPROACH_B_METHODS&#39;</span><span class="p">)</span>

    <span class="n">results_from_approach_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_approach_b</span><span class="p">()</span><span class="o">.</span><span class="n">do_approach_b</span><span class="p">(</span>
        <span class="n">methods</span><span class="o">=</span><span class="n">methods</span><span class="p">,</span> <span class="n">provide_best_only</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">tgf_funding_under_approach_b</span> <span class="o">=</span> <span class="n">results_from_approach_b</span><span class="o">.</span><span class="n">tgf_budget_by_country</span>

    <span class="n">country_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_country_projections_given_funding_dollar_amounts</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">tgf_funding_under_approach_b</span><span class="p">)</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_tgf_funding</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">PortfolioProjection</span><span class="p">(</span>
        <span class="n">tgf_funding_by_country</span><span class="o">=</span><span class="n">tgf_funding_under_approach_b</span><span class="p">,</span>
        <span class="n">non_tgf_funding_by_country</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">non_tgf_funding</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
        <span class="n">country_results</span><span class="o">=</span><span class="n">country_results</span><span class="p">,</span>
        <span class="n">portfolio_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_portfolio_results</span><span class="p">(</span>
            <span class="n">country_results</span><span class="o">=</span><span class="n">country_results</span><span class="p">,</span>
            <span class="n">adjust_for_unmodelled_innovation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">innovation_on</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="src.tgftools.analysis.Analysis.portfolio_projection_approach_c" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">portfolio_projection_approach_c</span><span class="p">(</span><span class="n">funding_fraction</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns the PortfolioProjection For Approach C: i.e., the funding fraction is the same in all countries</p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/analysis.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">portfolio_projection_approach_c</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funding_fraction</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PortfolioProjection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the PortfolioProjection For Approach C: i.e., the funding fraction is the same in all countries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">country_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_country_projection_given_funding_fraction</span><span class="p">(</span><span class="n">funding_fraction</span><span class="o">=</span><span class="n">funding_fraction</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PortfolioProjection</span><span class="p">(</span>
        <span class="n">tgf_funding_by_country</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># In this scenario, we do not know the split between TGF and non-TGF sources</span>
        <span class="n">non_tgf_funding_by_country</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">country_results</span><span class="o">=</span><span class="n">country_results</span><span class="p">,</span>
        <span class="n">portfolio_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_portfolio_results</span><span class="p">(</span>
            <span class="n">country_results</span><span class="o">=</span><span class="n">country_results</span><span class="p">,</span>
            <span class="n">adjust_for_unmodelled_innovation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">innovation_on</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="src.tgftools.analysis.Analysis.portfolio_projection_counterfactual" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">portfolio_projection_counterfactual</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns a PortfolioProjection for a chosen counterfactual scenario.</p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/analysis.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">portfolio_projection_counterfactual</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PortfolioProjection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a PortfolioProjection for a chosen counterfactual scenario.&quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;scenario_descriptor&#39;</span><span class="p">),</span>\
        <span class="sa">f</span><span class="s2">&quot;Counterfactual </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> not found in model results.&quot;</span>

    <span class="c1"># Create dict of country_results corresponding to the counterfactual scenario</span>
    <span class="n">country_results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">countries</span><span class="p">:</span>

        <span class="n">model_projection</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">indicator</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">country</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">indicator</span><span class="p">)]</span>
                <span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;funding_fraction&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;central&#39;</span><span class="p">:</span> <span class="s1">&#39;model_central&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="s1">&#39;model_low&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="s1">&#39;model_high&#39;</span><span class="p">})</span>
            <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">model_results</span><span class="o">.</span><span class="n">indicators</span>
        <span class="p">}</span>

        <span class="n">country_results</span><span class="p">[</span><span class="n">country</span><span class="p">]</span> <span class="o">=</span> <span class="n">CountryProjection</span><span class="p">(</span>
            <span class="n">model_projection</span><span class="o">=</span><span class="n">model_projection</span><span class="p">,</span>
            <span class="n">funding</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">PortfolioProjection</span><span class="p">(</span>
        <span class="n">tgf_funding_by_country</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">countries</span><span class="p">},</span>
        <span class="n">non_tgf_funding_by_country</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">countries</span><span class="p">},</span>
        <span class="n">country_results</span><span class="o">=</span><span class="n">country_results</span><span class="p">,</span>
        <span class="n">portfolio_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_portfolio_results</span><span class="p">(</span><span class="n">country_results</span><span class="p">,</span> <span class="n">adjust_for_unmodelled_innovation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h2 id="src.tgftools.analysis.CountryProjection" class="doc doc-heading">
          <code>CountryProjection</code>


</h2>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="typing.NamedTuple">NamedTuple</span></code></p>

  
      <p>NamedTuple for cases and death for a given program cost in a given country.</p>

            <details class="quote">
              <summary>Source code in <code>src/tgftools/analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CountryProjection</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;NamedTuple for cases and death for a given program cost in a given country.&quot;&quot;&quot;</span>

    <span class="n">model_projection</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span>
        <span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">]</span>  <span class="c1"># dict of the form {&lt;indicator&gt;: &lt;pd.DataFrame&gt;}</span>
    <span class="n">funding</span><span class="p">:</span> <span class="nb">float</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h2 id="src.tgftools.analysis.PortfolioProjection" class="doc doc-heading">
          <code>PortfolioProjection</code>


</h2>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="typing.NamedTuple">NamedTuple</span></code></p>

  
      <p>NamedTuple for the results of an Analysis.</p>

            <details class="quote">
              <summary>Source code in <code>src/tgftools/analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">PortfolioProjection</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;NamedTuple for the results of an Analysis.&quot;&quot;&quot;</span>

    <span class="n">tgf_funding_by_country</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>

    <span class="n">non_tgf_funding_by_country</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>

    <span class="n">country_results</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span>
        <span class="nb">str</span><span class="p">,</span> <span class="n">CountryProjection</span>
    <span class="p">]</span>  <span class="c1"># dict of the form {&lt;country&gt;: &lt;CountryProjection&gt;}</span>

    <span class="n">portfolio_results</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span>
        <span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">]</span>  <span class="c1"># dict of the form {&lt;indicator&gt;: &lt;pd.DataFrame&gt;}, where the pd.DataFrame has years in the row, and columns</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>




  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<a id="src.tgftools.report"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">




<h2 id="src.tgftools.report.Report" class="doc doc-heading">
          <code>Report</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>This is the BaseClass for Report classes. It provides the core functionality to generate reports. It can be
inherited from to allow it to accept sets of PortfolioProjections for the diseases. It intended that each member
function will either: (i) return a Dict of the form {<label>: <stat>}, or (ii) return a pd.DataFrame. These can be
assembled into an output Excel file: contents of dicts are written to the 'Stats' worksheet; contents of
pd.DataFrames are written to their own sheet of the same name.</p>

            <details class="quote">
              <summary>Source code in <code>src/tgftools/report.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Report</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is the BaseClass for Report classes. It provides the core functionality to generate reports. It can be</span>
<span class="sd">    inherited from to allow it to accept sets of PortfolioProjections for the diseases. It intended that each member</span>
<span class="sd">    function will either: (i) return a Dict of the form {&lt;label&gt;: &lt;stat&gt;}, or (ii) return a pd.DataFrame. These can be</span>
<span class="sd">    assembled into an output Excel file: contents of dicts are written to the &#39;Stats&#39; worksheet; contents of</span>
<span class="sd">    pd.DataFrames are written to their own sheet of the same name.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise the Report Class&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_all_funcs_to_generate_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of the functions in the class that will generate statistics (i.e., any function with a name</span>
<span class="sd">        that does not start with &quot;_&quot; and is not called &quot;report&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">name</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;report&quot;</span><span class="p">))</span>
                    <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run all member functions, print the results to screen, returns the results in the form of dictionary and</span>
<span class="sd">        (if filename provided) assemble them into an Excel file and draw graphs.&quot;&quot;&quot;</span>

        <span class="n">all_results_for_stats_pages</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># Storage for all the results</span>
        <span class="n">all_results_for_individual_worksheets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">all_funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_funcs_to_generate_stats</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ch_name</span> <span class="ow">in</span> <span class="n">all_funcs</span><span class="p">:</span>
            <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;** </span><span class="si">{</span><span class="n">ch_name</span><span class="si">}</span><span class="s2"> **&quot;</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">ch_name</span><span class="p">)()</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">all_results_for_stats_pages</span><span class="p">[</span><span class="n">ch_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">all_results_for_individual_worksheets</span><span class="p">[</span><span class="n">ch_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return from </span><span class="si">{</span><span class="n">ch_name</span><span class="si">}</span><span class="s2"> function is not of recognised type (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ch_name</span><span class="p">)</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>

        <span class="c1"># Compile the results for the &#39;stats&#39; summary</span>
        <span class="n">results_for_main</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">func_results</span> <span class="ow">in</span> <span class="n">all_results_for_stats_pages</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">stat_name</span><span class="p">,</span> <span class="n">stat_result</span> <span class="ow">in</span> <span class="n">func_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">results_for_main</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">func_name</span><span class="p">,</span> <span class="n">stat_name</span><span class="p">,</span> <span class="n">stat_result</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Write to Excel</span>
            <span class="n">wb</span> <span class="o">=</span> <span class="n">Workbook</span><span class="p">()</span>

            <span class="c1"># Write to &#39;stats&#39; worksheet:</span>
            <span class="n">work_sheet_stats</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">active</span>
            <span class="n">work_sheet_stats</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;stats&#39;</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">results_for_main</span><span class="p">:</span>
                <span class="n">work_sheet_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="c1"># Write results to &#39;individual&#39; worksheet</span>
            <span class="k">for</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">func_results</span> <span class="ow">in</span> <span class="n">all_results_for_individual_worksheets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">work_sheet</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">create_sheet</span><span class="p">()</span>
                <span class="n">work_sheet</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">func_name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>  <span class="c1"># truncate to first ten characters, as requirement of Excel</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">dataframe_to_rows</span><span class="p">(</span><span class="n">func_results</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="n">work_sheet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

            <span class="c1"># Do any post-processing that may be required</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_post_processing_on_workbook</span><span class="p">(</span><span class="n">wb</span><span class="p">)</span>

            <span class="c1"># Save</span>
            <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="c1"># Returning in the same format as the Excel file:</span>
            <span class="c1"># * key=&#39;main&#39;: a pd.DataFrame contains all the scalar stats from individual functions</span>
            <span class="c1"># * all other keys/sheets: pd.DataFrames from all the functions that returned pd.DataFrames</span>
            <span class="s1">&#39;stats&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results_for_main</span><span class="p">)</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;Function&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;Key&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;Value&#39;</span><span class="p">})</span>
            <span class="p">),</span>
            <span class="o">**</span><span class="n">all_results_for_individual_worksheets</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_post_processing_on_workbook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workbook</span><span class="p">:</span> <span class="n">Workbook</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do anything necessary to post-process the workbook: for instance, create graphs on certain worksheets.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h3 id="src.tgftools.report.Report.__init__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialise the Report Class</p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/report.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialise the Report Class&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="src.tgftools.report.Report.report" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">report</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Run all member functions, print the results to screen, returns the results in the form of dictionary and
(if filename provided) assemble them into an Excel file and draw graphs.</p>

          <details class="quote">
            <summary>Source code in <code>src/tgftools/report.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run all member functions, print the results to screen, returns the results in the form of dictionary and</span>
<span class="sd">    (if filename provided) assemble them into an Excel file and draw graphs.&quot;&quot;&quot;</span>

    <span class="n">all_results_for_stats_pages</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># Storage for all the results</span>
    <span class="n">all_results_for_individual_worksheets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="n">all_funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_funcs_to_generate_stats</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ch_name</span> <span class="ow">in</span> <span class="n">all_funcs</span><span class="p">:</span>
        <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;** </span><span class="si">{</span><span class="n">ch_name</span><span class="si">}</span><span class="s2"> **&quot;</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">ch_name</span><span class="p">)()</span>
        <span class="n">pprint</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">all_results_for_stats_pages</span><span class="p">[</span><span class="n">ch_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">all_results_for_individual_worksheets</span><span class="p">[</span><span class="n">ch_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return from </span><span class="si">{</span><span class="n">ch_name</span><span class="si">}</span><span class="s2"> function is not of recognised type (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ch_name</span><span class="p">)</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>

    <span class="c1"># Compile the results for the &#39;stats&#39; summary</span>
    <span class="n">results_for_main</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">func_results</span> <span class="ow">in</span> <span class="n">all_results_for_stats_pages</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">stat_name</span><span class="p">,</span> <span class="n">stat_result</span> <span class="ow">in</span> <span class="n">func_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">results_for_main</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">func_name</span><span class="p">,</span> <span class="n">stat_name</span><span class="p">,</span> <span class="n">stat_result</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Write to Excel</span>
        <span class="n">wb</span> <span class="o">=</span> <span class="n">Workbook</span><span class="p">()</span>

        <span class="c1"># Write to &#39;stats&#39; worksheet:</span>
        <span class="n">work_sheet_stats</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">active</span>
        <span class="n">work_sheet_stats</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;stats&#39;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">results_for_main</span><span class="p">:</span>
            <span class="n">work_sheet_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># Write results to &#39;individual&#39; worksheet</span>
        <span class="k">for</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">func_results</span> <span class="ow">in</span> <span class="n">all_results_for_individual_worksheets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">work_sheet</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">create_sheet</span><span class="p">()</span>
            <span class="n">work_sheet</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">func_name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>  <span class="c1"># truncate to first ten characters, as requirement of Excel</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">dataframe_to_rows</span><span class="p">(</span><span class="n">func_results</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">work_sheet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># Do any post-processing that may be required</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_post_processing_on_workbook</span><span class="p">(</span><span class="n">wb</span><span class="p">)</span>

        <span class="c1"># Save</span>
        <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="c1"># Returning in the same format as the Excel file:</span>
        <span class="c1"># * key=&#39;main&#39;: a pd.DataFrame contains all the scalar stats from individual functions</span>
        <span class="c1"># * all other keys/sheets: pd.DataFrames from all the functions that returned pd.DataFrames</span>
        <span class="s1">&#39;stats&#39;</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results_for_main</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;Function&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;Key&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;Value&#39;</span><span class="p">})</span>
        <span class="p">),</span>
        <span class="o">**</span><span class="n">all_results_for_individual_worksheets</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
    
  </body>
</html>